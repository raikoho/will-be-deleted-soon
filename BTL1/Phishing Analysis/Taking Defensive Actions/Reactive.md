## Immediate Response Process

These steps will work to triage the attack, and take measures to address the risk generated by malicious emails being successfully delivered to employee mailboxes. The steps are:

1. **Retrieve an original copy of the phishing email**
2. **Gather artifacts from the phishing email**
3. **Inform the recipients that received the email**
4. **Investigate malicious artifacts to collect indicators of compromise that can be blocked to protect the organization**
5. **Take defensive measures**
6. **Complete the investigation report, documenting all of the above steps**
#### 1) Retrieve an Original of the Suspicious Email:

An original version of the email can be obtained via a number of methods, such as; through security technology on the email gateway or the gateway itself, pulling the email directly from the email solution, such as Microsoft Exchange servers, or having an employee forward the email to a security-owned mailbox.
#### 2) Gather Artifacts From the Original Email:

We have already covered the artifacts we need to collect, and why they’re important. These are used later in the investigation process to perform artifact analysis and take defensive measures.
#### 3) Inform Email Recipients:

A crucial part of the immediate response to a phishing attack is to notify any individuals that have received the email. This helps to reduce the chance of them opening and interacting with the email.

Typically organizations will have an email template that they can send to recipients once they have been identified. The investigating analyst would check on the email gateway to see which mailboxes the phishing email has been delivered to, and then add the recipients into BCC of the email template, and include the following details:

- **The date and time the email was sent** (allows the recipients to find the email easier by looking at the times of emails that they have received)
- **The subject line of the malicious email** (allows the recipients to find the email easier by looking at the subject lines of emails that they have received)
- **Clear instructions on what to do with the email** (this will depend on how the organization deals with phishing emails. This could either be instructing the recipients to delete the email or forward it to a security-owned mailbox)
- **Contact details for if the recipient is unsure what to do** (typically a security-owned mailbox, so the user can get support from the security team)
#### 4) Artifact Analysis and Investigation:

We have already covered how to investigate email, web, and file-based artifacts to collect more information and determine how malicious they are. Tools that should be used include enterprise-grade sandboxing, URL2PNG, VirusTotal, IPVoid, WannaBrowser, a virtual machine, and more.
#### 5) Take Defensive Measures:

Defensive measures are the actions taken by the security team to reduce the risk generated by the phishing attack. This potentially includes blocking email, web, and file-based artifacts. If a malicious email includes a URL that takes the user to a credential harvester, blocking this URL on a web proxy would prevent employees from connecting to the webpage, completely mitigating the risk of them entering their credentials. We will cover blocking email, web, and file-based artifacts in the next three lessons.
#### 6) Complete Investigation Report:

We will cover this in detail in a later section. Your investigation report will include notes about all of the steps you have completed during the immediate response process. This provides an audit trail to show that the email was identified, investigated, and defensive measures were taken to protect the organization from this attack.

------
## Blocking Email Artifacts

Once we have collected and analyzed email artifacts, we are able to take defensive measures in order to block incoming and outgoing emails that feature these artifacts. Just to recap, the email artifacts that are important to us include:

- **Email Sender** (mailbox@domain)
- **Sender Domain** (@domain)
- **Sending Server IP**
- **Subject Line**
#### Email Sender

If a large volume of malicious emails is being sent from the same sender, we would definitely want to block it on the email gateway, preventing more emails from coming into the domain and landing in employee mailboxes. This is the primary block we will take with phishing attacks.

On the email gateway, we would typically block incoming emails from the specified sender, however, we could make this block bi-directional, and prevent emails from inside being sent to (recipient) the malicious sender – this would stop emails where an employee is trying to reply to the malicious email.
#### Sender Domain

The step-up from blocking the sending address (mailbox@domain) is to block the entire sending domain. When receiving emails from @Outlook or @Gmail, it’s obviously not feasible to block these entire domains, as there is a large potential for blocking legitimate emails (such as employees contacting Payroll from their personal addresses, HR reaching out to new employees via their personal addresses, etc). This is typically only done when the sending domain is purely malicious or is using a large number of mailboxes to send malicious emails.
#### Sending Server IP

This is a very serious block and is not conducted unless it is absolutely necessary. This will drop any emails coming from the specified IP. Whilst similar to a domain block, a domain may use multiple sending servers, so this would be less effective, and is tailored towards rogue IPs that have been compromised or set up to send malicious emails.
#### Subject Line

Phishing attacks will typically use one subject line, otherwise, the attackers need to keep modifying it, creating more work (and likely more cost if they’re using paid-for email services). 
Whilst multiple sending addresses can be delivering the same phishing email, if they all share the same subject line we can easily catch them all, instead of blocking multiple senders, by dropping any emails with the subject line in question.

---
## Blocking Web Artifacts

**There are two types of blocks we want to make on a web proxy – a URL block, and a domain block.**
#### URL Blocks

URL blocks are extremely specific, and will **only** block the URL that has been provided. If we have a credential harvester that is using the URL “

We can block URLs at a specific point, in order to be more effective and catch more potential malicious URLs. In the example above (“`hxxp://elephantsanctuary[.]com/index/2019/hgasdf/11/outlook/owa.php?`”) we could block the first directory that looks suspicious, in this case, it would be “hgasdf”. By blocking “`domain[.]com/index2019/hgasdf`”, anything that comes after that directory will be blocked and the connection will not get outside of the network.

**So when deciding on a URL block, work out if the full URL is static and would work for all recipients, or if there is an obviously malicious directory where the URL block can end.**

#### Domain Blocks

Domain blocks work to prevent access to **an entire domain**. 
If we wanted to block Google.com (please dear god never do this), then it would prevent any web requests from going out to Google, including any subdomains or any URLs. 

Revisiting the example above, if the domain was discovered to be created with purely malicious intent or has been compromised and there is no business justification for employees to visit the site, we can block the entire domain, in this case, it would be “`elephantsanctuary[.]com`”. This would make any future attacks using the same domain, but new URLs, ineffective because traffic to that domain is already prohibited, and will never leave the organization.
#### DNS Blackholing

![](https://d2y9h8w1ydnujs.cloudfront.net/uploads/content/images/7ab39d4c1dc3c20182d27861d1194acab2a677d3ee3a41cdd26261d1c8dce1de3ecc49cba1e60b6dccc6517bd0f2.png)

Whilst firewalls and proxies are the standard method of blocking access from a private network out to resources on the internet, DNS blackholing can be used as a protective measure, but also an educational one. 

Blackholing is the process of creating a fake DNS entry so that if an employee tries to access “hxxp://thisisreallymalicious.com” they will actually be sent to another site. 
If an organization is hit by a large-scale campaign, and a high number of employees receive the same phishing email with a URL in it, blocking the domain (if appropriate) could be accompanied by a DNS blackhole, so if users click the link it goes to a safe landing page, telling them they just clicked a malicious URL. 
SIEM or EDR alerts can also be generated on any users making an outbound connection to the blackholed domain, so they can be highlighted for additional security awareness training.
#### Firewall

![](https://d2y9h8w1ydnujs.cloudfront.net/uploads/content/images/5260593a27271af121c9a6ee17b8a1184e3f3b4802aa20dc76d43e20c4be2599ae821e5f8a5cb610369422a02e6d.png)

When there are multiple malicious sites being hosted on the same IP, if there is no legitimate resource that the business would need access to running on that IP, we can block that server to prevent access to any of the sites on it. 

This is an extreme measure, and is typically not conducted when regarding phishing, and is often used to block IPs that are scanning or attacking the organization. 

Under the intelligence concept the ‘Pyramid of Pain’, which we cover in the Operational Intelligence section of the Threat Intelligence domain, IP addresses are the second easiest indicator for malicious actors to change, so it is likely that IP blocks will be countered by simply using a new IP, rendering the block useless.
#### Making The Decision

![](https://d2y9h8w1ydnujs.cloudfront.net/uploads/content/images/2f22053131104ebfea5c698188c267d45f3becafa0246e418ec97faa820528a2cfe7b1ee546ba9c84145ed776d3e.png)

The first thing you need to consider, has the domain been created for purely malicious activity, or has it been compromised? 

**If the domain has been created for purely malicious intent** (young age, no legitimate content, malicious content present) then you have sufficient justification to make a domain block on the web proxy. The site is malicious, and employees have no legitimate reason to visit it. It poses a risk to the business – mitigate the risk by blocking it.

**If the domain has been compromised** then you need to decide **whether employees would ever need to visit this domain for business purposes.** If they don’t, then the site can be domain blocked on the web proxy. The site has security weaknesses and has been taken over by hackers. If no employees need to access it, then there will be no negative impact by blocking it.

**If the domain has been compromised** and **employees may need to visit the site** then you should request a URL block, and ensure that the URL is appropriate for the type of attack observed. Can you block the full URL? Do you need to bring it down a couple of directories to include other malicious pages that the site may hold?

---
## Blocking File Artifacts

There are two standard types of blocks we can take when defending against malicious files;

- MD5, SHA1, or SHA256 hash blocking
- File name blocking

---